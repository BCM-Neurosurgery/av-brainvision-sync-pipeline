{% extends "layout_nbu.html" %}
{% set title = "Run #" ~ run['id'] ~ " — Audio/Video Synchronization" %}
{% set nav = "runs" %}
{% block content %}
  <div class="page-head">
    <div>
      <h1>Run #{{ run['id'] }}</h1>
    </div>
    <div class="actions"></div>
  </div>
  <div class="card">
    <div class="cardhead">
      <h3 style="margin:0">Status & logs</h3>
      <div class="actions">
        {% if run['status'] in ['scheduled','queued','running'] %}
          <form method="post" action="/runs/{{ run['id'] }}/cancel" class="inline">
            <button class="btn danger" type="submit">Cancel</button>
          </form>
        {% endif %}
      </div>
    </div>
    <div class="kv">
      <div class="k">State</div>
      <div class="v mono" id="status-text">{{ run['status'] }}</div>
      {% if run['cancel_requested'] %}
        <div class="k">Cancel</div>
        <div class="v">
          <span class="pill running">Requested</span>
        </div>
      {% endif %}
      <div class="k">Created</div>
      <div class="v mono" id="created_at">{{ run['created_at'] }}</div>
      <div class="k">Started</div>
      <div class="v mono" id="started_at">{{ run['started_at'] or "" }}</div>
      <div class="k">Finished</div>
      <div class="v mono" id="finished_at">{{ run['finished_at'] or "" }}</div>
      <div class="k">Exit code</div>
      <div class="v mono" id="exit_code">
        {{ run['exit_code'] if run['exit_code'] is not none else "" }}
      </div>
      <div class="k">PID</div>
      <div class="v mono" id="pid">{{ run['pid'] if run['pid'] is not none else "" }}</div>
    </div>
    {% if run['error'] %}<div class="alert danger mono">{{ run['error'] }}</div>{% endif %}
    <hr class="divider" />
    <h3 style="margin:0 0 10px 0">Inputs</h3>
    <div class="kv">
      <div class="k">Audio dir</div>
      <div class="v mono">{{ args.get('audio_dir', '') }}</div>
      <div class="k">Video dir</div>
      <div class="v mono">{{ args.get('video_dir', '') }}</div>
      <div class="k">Output dir</div>
      <div class="v mono">{{ args.get('out_dir', '') }}</div>
      <div class="k">Site</div>
      <div class="v mono">{{ args.get('site', '') }}</div>
    </div>
    <hr class="divider" />
    <h3 style="margin:0 0 10px 0">Options</h3>
    <div class="kv">
      <div class="k">Log level</div>
      <div class="v mono">{{ args.get('log_level', 'INFO') }}</div>
      <div class="k">Range mode</div>
      <div class="v mono">
        {% if args.get('time_start') and args.get('time_end') %}
          time
        {% elif args.get('audio_sample_start') is not none and args.get('audio_sample_end') is not none %}
          sample
        {% else %}
          manual
        {% endif %}
      </div>
      {% if args.get('time_start') and args.get('time_end') %}
        <div class="k">Time range</div>
        <div class="v mono">
          {{ args.get('time_start', '') }} → {{ args.get('time_end', '') }} ({{ args.get('time_zone', 'America/Chicago') }})
        </div>
      {% elif args.get('audio_sample_start') is not none and args.get('audio_sample_end') is not none %}
        <div class="k">Sample range</div>
        <div class="v mono">{{ args.get("audio_sample_start") }} → {{ args.get("audio_sample_end") }}</div>
      {% endif %}
      <div class="k">Reuse audio artifacts</div>
      <div class="v mono">{{ 'Yes' if args.get("skip_decode") else 'No' }}</div>
      <div class="k">Overwrite clips</div>
      <div class="v mono">{{ 'Yes' if args.get("overwrite_clips") else 'No' }}</div>
      <div class="k">Split</div>
      <div class="v mono">{{ 'Yes' if args.get("split") else 'No' }}</div>
      <div class="k">Split overwrite</div>
      <div class="v mono">{{ 'Yes' if args.get("split_overwrite") else 'No' }}</div>
      <div class="k">Split clean</div>
      <div class="v mono">{{ 'Yes' if args.get("split_clean") else 'No' }}</div>
    </div>
    <hr class="divider" />
    <div class="loghead" style="margin-top:14px">
      <h3>Live logs</h3>
      <div class="muted small">Auto-updates while the run is active.</div>
    </div>
    <pre id="log" class="log mono"></pre>
    <div class="actions right" style="margin-top:12px">
      <a class="btn" href="/runs">Close</a>
      <a class="btn" href="/runs/{{ run['id'] }}/logs" target="_blank">View logs</a>
    </div>
  </div>
  <script>
    const runId = {{ run['id'] }};
    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status-text");
    const createdEl = document.getElementById("created_at");
    const startedEl = document.getElementById("started_at");
    const finishedEl = document.getElementById("finished_at");
    const exitEl = document.getElementById("exit_code");
    const pidEl = document.getElementById("pid");
    const es = new EventSource(`/runs/${runId}/logs/stream`);
    const maxLogChars = 200000;
    const pending = [];
    let flushTimer = null;
    function flushLogs(){
      if(!pending.length){ return; }
      logEl.textContent += pending.join("\n") + "\n";
      pending.length = 0;
      if(logEl.textContent.length > maxLogChars){
        logEl.textContent = logEl.textContent.slice(-maxLogChars);
      }
      logEl.scrollTop = logEl.scrollHeight;
      flushTimer = null;
    }
    es.onmessage = (ev) => {
      if (ev.data === ""){ return; }
      pending.push(ev.data);
      if(!flushTimer){
        flushTimer = setTimeout(flushLogs, 120);
      }
    };
    async function refreshStatus(){
      try{
        const res = await fetch(`/api/runs/${runId}`);
        const data = await res.json();
        if(statusEl){ statusEl.textContent = data.status || ""; }
        if(createdEl){ createdEl.textContent = data.created_at || ""; }
        if(startedEl){ startedEl.textContent = data.started_at || ""; }
        if(finishedEl){ finishedEl.textContent = data.finished_at || ""; }
        if(exitEl){
          exitEl.textContent = (data.exit_code === null || data.exit_code === undefined) ? "" : String(data.exit_code);
        }
        if(pidEl){
          pidEl.textContent = (data.pid === null || data.pid === undefined) ? "" : String(data.pid);
        }
      }catch(e){}
    }
    setInterval(refreshStatus, 2000);
    refreshStatus();
  </script>
{% endblock %}
