{% extends "wizard_layout.html" %}
{% set nav = flow_nav or "new" %}
{% set title = flow_title or "New run" %}
{% set subtitle = flow_subtitle or "Step 1/6 — Select audio folder" %}
{% set step = 1 %}
{% block wizard %}
  <form class="form" method="post" action="/wizard/{{ draft_id }}/audio">
    <div class="card stack">
      <div class="card subcard">
        <label>
          <span class="label-row">
            <h3 style="margin:0">Audio dir</h3>
            <span class="help"
                  data-tip="Folder containing the channelized audio files (e.g., ...-01.mp3, ...-02.mp3, ...-03.mp3)."></span>
            <span id="audio_status" class="pill" style="margin-left:6px">Not checked</span>
          </span>
          <div class="input-row">
            <input id="audio_dir"
                   name="audio_dir"
                   required
                   value="{{ audio_dir or '' }}"
                   placeholder="/path/to/audio" />
            <button class="btn" type="button" onclick="browseDir('audio_dir')">Browse</button>
          </div>
        </label>
        <div id="audio_hint" class="hint" style="margin-top:6px"></div>
        <div class="actions"
             style="margin-top:12px;
                    justify-content:space-between">
          <a class="btn" href="{{ cancel_url or '/runs' }}">Cancel</a>
          <div class="actions">
            <button id="btn_recheck"
                    class="btn"
                    type="button"
                    onclick="validateAudio(true)">Re-check</button>
            <button id="btn_continue"
                    class="btn primary"
                    type="button"
                    onclick="location.href='/wizard/{{ draft_id }}/video'"
                    disabled
                    title="Continue is available after the audio check passes">Continue</button>
          </div>
        </div>
      </div>
      <div id="audio_result_wrap" class="stack">
        {% if error and not audio_result %}<div class="alert danger mono">{{ error }}</div>{% endif %}
        {% if audio_result %}
          {% set check_tips = {
            "Find audio files": "Finds .wav/.mp3 files in the selected folder.",
            "Naming pattern": "Validates filenames match <prefix>-<chan>.<ext> with chan=01/02/03 and ext wav/mp3.",
            "Serial channel present": "Ensures exactly one serial channel file (typically -03) is present.",
            "Program channel present": "Requires at least one program channel (-01 or -02); warns if one is missing.",
            "Sample rate detected": "Reads WAV headers or uses ffprobe for MP3 to determine sample rate; must be > 0.",
            "Duration detected": "Determines duration for each audio file (WAV: header; MP3: ffprobe); must be > 0."
          } %}
<div class="card subcard">
<div class="actions" style="justify-content:space-between; margin-bottom:10px">
<h3 style="margin:0">Checks</h3>
<div class="muted small">
Checked at <span class="mono">{{ audio_result.checked_at }}</span>
</div>
</div>
{% if audio_result.checks %}
<table class="table checks-table">
<thead>
<tr>
<th>Check</th>
<th class="right statuscol">Status</th>
</tr>
</thead>
<tbody>
{% for c in audio_result.checks %}
<tr>
<td>
<span class="label-row">
{{ c.name }}
<span class="help" data-tip="{{ check_tips.get(c.name, 'What this check validates in the audio folder.') }}"></span>
</span>
</td>
<td class="right statuscol">
{% if c.status == "pass" %}
<span class="pill succeeded">Pass</span>
{% elif c.status == "fail" %}
<span class="pill failed">Fail</span>
{% elif c.status == "running" %}
<span class="pill running">Running</span>
{% elif c.status == "warn" %}
<span class="pill running">Warn</span>
{% elif c.status == "skipped" %}
<span class="pill">Skipped</span>
{% elif c.status == "pending" %}
<span class="pill">Pending</span>
{% else %}
<span class="pill">{{ c.status }}</span>
{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
<div class="muted">No checks run yet.</div>
{% endif %}
</div>
<div class="card subcard">
<div class="actions" style="justify-content:space-between; margin-bottom:10px">
<h3 style="margin:0">Summary</h3>
</div>
{% set summary_error = (audio_result.error or error) %}
{% if (not audio_result.ok) and summary_error %}
<div class="danger-text mono" style="margin-top:0">{{ summary_error }}</div>
{% elif audio_result.ok and audio_result.files %}
<table class="table">
<thead>
<tr>
<th>File</th>
<th class="right">Sample rate</th>
<th class="right">Duration</th>
</tr>
</thead>
<tbody>
{% for f in audio_result.files %}
<tr>
<td class="mono">{{ f.name }}</td>
<td class="mono right">{{ f.sample_rate }}</td>
<td class="mono right">{{ f.duration }}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
<div class="muted">Summary will appear after checks pass.</div>
{% endif %}
</div>
{% endif %}
</div>
</div>
</form>
<script>
    const draftId = {{ draft_id }};
    const audioInput = document.getElementById("audio_dir");
    const statusPill = document.getElementById("audio_status");
    const hintEl = document.getElementById("audio_hint");
    const resultWrap = document.getElementById("audio_result_wrap");
    const continueBtn = document.getElementById("btn_continue");
    const recheckBtn = document.getElementById("btn_recheck");

    function esc(s){
      return String(s ?? "").replace(/[&<>\"']/g, (c) => ({
        "&":"&amp;","<":"&lt ;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function setStatus(kind, text){
      statusPill.className = "pill";
      if(kind === "checking"){ statusPill.classList.add("running"); }
      if(kind === "ok"){ statusPill.classList.add("succeeded"); }
      if(kind === "fail"){ statusPill.classList.add("failed"); }
      statusPill.textContent = text;
    }

    function setContinue(enabled){
      continueBtn.disabled = !enabled;
      if(enabled){
        continueBtn.title = "";
      }else{
        continueBtn.title = "Continue is available after the audio check passes";
      }
    }

    function renderResult(data){
      if(!data){
        return;
      }

      const checkTips = {
        "Find audio files": "Finds .wav/.mp3 files in the selected folder.",
        "Naming pattern": "Validates filenames match <prefix>-<chan>.<ext> with chan=01/02/03 and ext wav/mp3.",
        "Serial channel present": "Ensures exactly one serial channel file (typically -03) is present.",
        "Program channel present": "Requires at least one program channel (-01 or -02); warns if one is missing.",
        "Sample rate detected": "Reads WAV headers or uses ffprobe for MP3 to determine sample rate; must be > 0.",
        "Duration detected": "Determines duration for each audio file (WAV: header; MP3: ffprobe); must be > 0."
      };

      const ok = !!data.ok;
      const checkedAt = data.checked_at ? esc(data.checked_at) : "";
      const files = Array.isArray(data.files) ? data.files : [];
      const checks = Array.isArray(data.checks) ? data.checks : [];
      const err = data.error ? esc(data.error) : "";

      let html = "";
      // Checks card
      html += `<div class="card subcard">`;
      html += `<div class="actions" style="justify-content:space-between; margin-bottom:10px">`;
      html += `<h3 style="margin:0">Checks</h3>`;
      html += `<div class="muted small">Checked at <span class="mono">${checkedAt}</span></div>`;
      html += `</div>`;
      if(checks.length){
        html += `<table class="table checks-table"><thead><tr><th>Check</th><th class="right statuscol">Status</th></tr></thead><tbody>`;
        for(const c of checks){
          const name = esc(c.name);
          const status = String(c.status ?? "");
          const tip = esc(checkTips[String(c.name ?? "")] || "What this check validates in the audio folder.");
          let pill = `<span class="pill">${esc(status)}</span>`;
          if(status === "pass"){ pill = `<span class="pill succeeded">Pass</span>`; }
          if(status === "fail"){ pill = `<span class="pill failed">Fail</span>`; }
          if(status === "running"){ pill = `<span class="pill running">Running</span>`; }
          if(status === "warn"){ pill = `<span class="pill running">Warn</span>`; }
          if(status === "pending"){ pill = `<span class="pill">Pending</span>`; }
          if(status === "skipped"){ pill = `<span class="pill">Skipped</span>`; }
          html += `<tr><td><span class="label-row">${name}<span class="help" data-tip="${tip}"></span></span></td><td class="right statuscol">${pill}</td></tr>`;
        }
        html += `</tbody></table>`;
      }else{
        html += `<div class="muted">No checks run yet.</div>`;
      }
      html += `</div>`;

      // Summary card
      html += `<div class="card subcard">`;
      html += `<div class="actions" style="justify-content:space-between; margin-bottom:10px">`;
      html += `<h3 style="margin:0">Summary</h3>`;
      html += `</div>`;

      if(!ok && err){
        html += `<div class="danger-text mono" style="margin-top:0">${err}</div>`;
      }else if(ok && files.length){
        html += `<table class="table"><thead><tr><th>File</th><th class="right">Sample rate</th><th class="right">Duration</th></tr></thead><tbody>`;
        for(const f of files){
          const name = esc(f.name);
          const sr = esc(f.sample_rate);
          const dur = esc(f.duration);
          html += `<tr><td class="mono">${name}</td><td class="mono right">${sr}</td><td class="mono right">${dur}</td></tr>`;
        }
        html += `</tbody></table>`;
      }else{
        html += `<div class="muted">Summary will appear after checks pass.</div>`;
      }
      html += `</div>`;
      resultWrap.innerHTML = html;
      hintEl.textContent = "";
    }

    let validateTimer = null;
    let pollTimer = null;
    async function validateAudio(force){
      const dir = (audioInput.value || "").trim();
      if(!dir){
        setStatus("idle", "Not checked");
        setContinue(false);
        if(recheckBtn) recheckBtn.disabled = true;
        if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
        hintEl.textContent = "";
        return;
      }

      if(recheckBtn) recheckBtn.disabled = true;
      setStatus("checking", "Checking…");
      setContinue(false);
      try{
        const res = await fetch(`/api/drafts/${draftId}/validate-audio/start?audio_dir=${encodeURIComponent(dir)}`);
        const data = await res.json();
        renderResult(data);
        if(data && !data.running){
          if(recheckBtn) recheckBtn.disabled = false;
        }

        if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
        pollTimer = setInterval(async () => {
          try{
            const r = await fetch(`/api/drafts/${draftId}/validate-audio/status`);
            const d = await r.json();
            renderResult(d);
            if(d && d.running){
              setStatus("checking", "Checking…");
              setContinue(false);
              if(recheckBtn) recheckBtn.disabled = true;
            }else if(d && d.ok){
              setStatus("ok", "Passed");
              setContinue(true);
              if(recheckBtn) recheckBtn.disabled = false;
              if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
            }else{
              setStatus("fail", "Failed");
              setContinue(false);
              if(recheckBtn) recheckBtn.disabled = false;
              if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
            }
          }catch(e){
            // ignore transient polling errors
          }
        }, 350);
      }catch(e){
        setStatus("fail", "Failed");
        setContinue(false);
        if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
        resultWrap.innerHTML = `<div class="alert danger mono">Failed to validate audio folder.</div>`;
      }
    }

    function scheduleValidate(){
      if(validateTimer) clearTimeout(validateTimer);
      validateTimer = setTimeout(() => validateAudio(false), 450);
    }

    audioInput.addEventListener("input", scheduleValidate);

    async function browseDir(inputId){
      const input = document.getElementById(inputId);
      const initial = input?.value || "";
      const btn = document.activeElement;
      const prevText = (btn && btn.tagName === "BUTTON") ? btn.textContent : null;
      try{
        if(btn && btn.tagName === "BUTTON"){ btn.disabled = true; btn.textContent = "Opening…"; }
        const res = await fetch(`/api/pick-dir?initial=${encodeURIComponent(initial)}`);
        const data = await res.json();
        if(data && data.path){
          input.value = data.path;
          input.dispatchEvent(new Event("input"));
        }else if(data && data.error){
          alert(data.error);
        }
      }catch(e){
        alert("Directory picker is not available in this environment.");
      }finally{
        if(btn && btn.tagName === "BUTTON"){ btn.disabled = false; if(prevText!==null) btn.textContent = prevText; }
      }
    }

    (function init(){
      const ok = {{ "true" if audio_ok else "false" }};
      if(ok){
        setStatus("ok", "Passed");
        setContinue(true);
      }else if((audioInput.value || "").trim()){
        // Ensure results are current (and show progress) when a folder is already filled in.
        scheduleValidate();
      }else{
        setStatus("idle", "Not checked");
        setContinue(false);
        if(recheckBtn) recheckBtn.disabled = true;
      }
    })();
</script>
{% endblock %}
